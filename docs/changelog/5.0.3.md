# Changelog v5.0.3

**Release Date:** 2026-01-15

## Summary

New ChannelFilter extension point and notification scheduler plugin for time-based
notification channel filtering.

## Changes

### Added

-   **ChannelFilter Extension Point** (`extensions/base.py`)
    -   New extension point for filtering notification channels before sending
    -   Allows plugins to control which channels receive notifications
    -   Supports channel-specific configuration overrides (e.g., email recipient)
    -   **Returns 3-tuple**: `(enabled_channels, channel_overrides, frequency_words_path)`
    -   Backward compatible: 2-tuple returns are still supported
    -   Use cases: schedule-based notifications, channel allowlist/blocklist, topic-based filtering

-   **Notification Scheduler Plugin** (`extensions/notification_scheduler/`)
    -   Time-based notification scheduling with platform filtering
    -   Configure specific times when notifications should be sent
    -   Filter platforms per schedule (e.g., only feishu and telegram at 9:00)
    -   Â±5 minute time tolerance (configurable)
    -   Email recipient override per schedule
    -   **Custom frequency_words per schedule** - specify different keyword config files
      for different time slots (e.g., tech keywords at 9:00, investment keywords at 14:00)
    -   Fallback to default behavior when no schedule matches
    -   Config: `config/extensions/notification_scheduler.yaml`

-   **ChannelFilter Integration** (`trendradar/__main__.py`)
    -   Integrated ChannelFilter extension point into notification dispatch
    -   Channel filtering applied before sending notifications
    -   Channel-specific overrides (e.g., email.to) applied dynamically
    -   **Dynamic statistics recalculation** when custom frequency_words is specified
    -   Console output shows filtered channels, overrides, and custom keyword config

-   **ExtensionManager.apply_channel_filter()** (`extensions/__init__.py`)
    -   New method to apply all ChannelFilter plugins
    -   Combines results from multiple filter plugins (union)
    -   Merges channel overrides from all plugins
    -   **Returns 3-tuple** with optional frequency_words_path (first plugin that specifies wins)

### Changed

-   **ExtensionPoint.enabled property** (`extensions/base.py`)
    -   Changed from simple property to use internal `_enabled` attribute
    -   Allows proper configuration via `apply_config()`

-   **notification_scheduler bypasses push_window** (`trendradar/__main__.py`)
    -   When notification_scheduler matches a schedule, it now bypasses `push_window` checks
    -   Skips both time range check and `once_per_day` check when scheduler matches
    -   Works even when `push_window.enabled` is false
    -   ChannelFilter check moved before push_window for proper priority

-   **Loguru log level configuration** (`extensions/__init__.py`)
    -   Added `_configure_logger()` to control log level
    -   Respects `LOG_LEVEL` environment variable (highest priority)
    -   Falls back to `advanced.debug` setting in config.yaml
    -   Default level is `INFO` (hides DEBUG logs in production)

### Configuration Example

```yaml
# config/extensions/notification_scheduler.yaml
enabled: true
tolerance_minutes: 5
schedules:
  - time: "09:00"
    platforms: ["feishu", "telegram"]
    frequency_words: "config/frequency_words_tech.txt"  # Custom keywords for morning
  - time: "14:00"
    platforms: ["feishu", "dingtalk", "wework"]
    frequency_words: "config/frequency_words_invest.txt"  # Custom keywords for afternoon
  - time: "18:00"
    platforms: ["feishu", "dingtalk", "wework", "telegram", "email"]
    email:
      to: "recipient@example.com"
    # No frequency_words - uses default config
```

## Migration Notes

-   No breaking changes
-   New extension point is opt-in; existing behavior unchanged without configuration

## Related Issues

-   N/A

## Contributors

-   N/A
