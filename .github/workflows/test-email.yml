name: ğŸ§ª Test 163 Email
on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  send-test-email:
    runs-on: ubuntu-latest
    steps:
      - name: Send email via 163 SMTP
        env:
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
        run: |
          python3 - <<'EOF'
import os
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# è·å–ç¯å¢ƒå˜é‡
FROM = os.environ['EMAIL_FROM']
PASSWORD = os.environ['EMAIL_PASSWORD']
TO = os.environ['EMAIL_TO']
SMTP_SERVER = os.environ['EMAIL_SMTP_SERVER']
SMTP_PORT = int(os.environ['EMAIL_SMTP_PORT'])

# åˆ›å»ºé‚®ä»¶
msg = MIMEMultipart()
msg['From'] = FROM
msg['To'] = TO
msg['Subject'] = "[Test] GitHub Actions é‚®ä»¶æµ‹è¯•æˆåŠŸï¼"

body = f"""
âœ… æ­å–œï¼æ‚¨å·²æˆåŠŸé€šè¿‡ GitHub Actions å‘é€ 163 é‚®ç®±æµ‹è¯•é‚®ä»¶ã€‚

- å‘ä»¶äºº: {FROM}
- æ”¶ä»¶äºº: {TO}
- ä»“åº“: {os.environ.get('GITHUB_REPOSITORY', 'unknown')}
- è¿è¡ŒID: {os.environ.get('GITHUB_RUN_ID', 'N/A')}

æ­¤é‚®ä»¶ç”±è‡ªåŠ¨åŒ–å·¥ä½œæµå‘é€ï¼Œä»…ç”¨äºæµ‹è¯•ã€‚
"""
msg.attach(MIMEText(body, 'plain', 'utf-8'))

# å‘é€é‚®ä»¶ï¼ˆæ”¯æŒ 465 SSL æˆ– 25/587 STARTTLSï¼‰
if SMTP_PORT == 465:
    server = smtplib.SMTP_SSL(SMTP_SERVER, SMTP_PORT)
else:
    server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
    server.starttls()

server.login(FROM, PASSWORD)
server.sendmail(FROM, TO, msg.as_string())
server.quit()

print("ğŸ“§ 163 æµ‹è¯•é‚®ä»¶å‘é€æˆåŠŸï¼")
EOF