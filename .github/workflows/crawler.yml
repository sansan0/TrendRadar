name: Hot News Crawler
on:
  schedule:
    - cron: "0 0-14 * * *"  # æ”¹ä¸ºæ¯å°æ—¶æ‰§è¡Œï¼Œé™ä½å°å·é£é™©ï¼ˆå¯é€‰ï¼‰
  workflow_dispatch:
    inputs:
      debug:
        description: 'æ˜¯å¦å¼€å¯è°ƒè¯•æ¨¡å¼'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: crawler-${{ github.ref_name }}
  cancel-in-progress: false  # ä¸ç»ˆæ­¢æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # ç¼©çŸ­è¶…æ—¶æ—¶é—´

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Verify required files
        run: |
          echo "ğŸ” æ£€æŸ¥å¿…éœ€çš„é…ç½®æ–‡ä»¶..."
          if [ ! -f config/config.yaml ]; then
            echo "âŒ é”™è¯¯: config/config.yaml æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f config/frequency_words.txt ]; then
            echo "âŒ é”™è¯¯: config/frequency_words.txt æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡ "

      - name: Check required secrets
        run: |
          # æ£€æŸ¥æ ¸å¿ƒæ¨é€å¯†é’¥ï¼ˆæ ¹æ®è„šæœ¬éœ€æ±‚è°ƒæ•´ï¼‰
          if [ -z "$FEISHU_WEBHOOK_URL" ] && [ -z "$TELEGRAM_BOT_TOKEN" ] && [ -z "$DINGTALK_WEBHOOK_URL" ]; then
            echo "âŒ é”™è¯¯ï¼šè‡³å°‘é…ç½®ä¸€ä¸ªæ¨é€æ¸ é“çš„å¯†é’¥ï¼ˆé£ä¹¦/ç”µæŠ¥/é’‰é’‰ï¼‰"
            exit 1
          fi
          
      - name: Run crawler
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL || '' }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN || '' }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID || '' }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL || '' }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL || '' }}
          WEWORK_MSG_TYPE: ${{ secrets.WEWORK_MSG_TYPE || '' }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM || '' }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD || '' }}
          EMAIL_TO: ${{ secrets.EMAIL_TO || '' }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER || '' }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT || '' }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC || '' }}
          NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL || '' }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN || '' }}
          BARK_URL: ${{ secrets.BARK_URL || '' }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || '' }}
          GITHUB_ACTIONS: true
          DEBUG_MODE: ${{ github.event.inputs.debug }}
        run: |
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œçˆ¬è™«è„šæœ¬ï¼ˆè°ƒè¯•æ¨¡å¼ï¼š$DEBUG_MODEï¼‰"
          python main.py 2>&1 | tee crawler.log
          echo "ğŸ“Š çˆ¬è™«æ‰§è¡Œå®Œæˆï¼Œé€€å‡ºç ï¼š$?"
          
      - name: Upload crawler log
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: crawler-log
          path: crawler.log
          
      - name: Commit and push if changes
        env:
          BRANCH_NAME: ${{ github.event.repository.default_branch }}
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          echo "ğŸ”„ åŒæ­¥è¿œç¨‹åˆ†æ”¯ $BRANCH_NAME..."
          git fetch origin $BRANCH_NAME
          # æ‹‰å–è¿œç¨‹æœ€æ–°ï¼Œé¿å…å†²çª
          git pull --rebase origin $BRANCH_NAME || {
            echo "âš ï¸ æ‹‰å–å¤±è´¥ï¼Œå°è¯•æ”¾å¼ƒå˜åŸº"
            git rebase --abort
          }
          
          git add -A
          
          if git diff --quiet && git diff --staged --quiet; then
            echo "ğŸ“­ æ— æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤"
            exit 0
          fi
          
          echo "ğŸ“ æäº¤å˜æ›´..."
          TIMESTAMP=$(TZ=Asia/Shanghai date "+%Y-%m-%d %H:%M:%S")
          git commit -m "Auto update by GitHub Actions at $TIMESTAMP"
          
          echo "â¬†ï¸ æ¨é€å˜æ›´ï¼ˆ5æ¬¡é‡è¯•ï¼‰..."
          for i in {1..5}; do
            git push origin $BRANCH_NAME && {
              echo "âœ… ç¬¬ $i æ¬¡æ¨é€æˆåŠŸ"
              exit 0
            }
            echo "âš ï¸ ç¬¬ $i æ¬¡æ¨é€å¤±è´¥ï¼Œç­‰å¾… $((i*3)) ç§’..."
            sleep $((i * 3))
          done
          
          echo "âŒ 5æ¬¡æ¨é€å‡å¤±è´¥"
          exit 1
