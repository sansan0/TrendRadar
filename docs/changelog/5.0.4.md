# v5.0.4 - Rolling Window Database Architecture

**Release Date**: 2026-01-16

## Overview

Introduces a new Rolling Window storage architecture that consolidates per-date SQLite files into a hot/cold data separation model for improved performance and simpler management.

## New Features

### Rolling Window Storage Backend

- **Hot/Cold Data Separation**: New `RollingWindowLocalBackend` that uses two database files:
  - `current.db` - Hot data (recent N days, default: 7)
  - `archive.db` - Cold data (older records)

- **SQL Query Optimization**: New `detect_new_titles_sql()` and `detect_new_rss_items_sql()` methods that use SQL subqueries instead of loading all data into Python memory, reducing memory usage by ~10x for large datasets.

- **Automatic Maintenance**: When enabled, automatically:
  - Migrates data older than `hot_days` from current.db to archive.db
  - Cleans up archive data older than `archive_retention_days`
  - Runs VACUUM to reclaim disk space

### Configuration Options

New `storage.rolling_window` configuration section:

```yaml
storage:
  rolling_window:
    enabled: false                    # Enable rolling window mode
    hot_days: 7                       # Days to keep in current.db
    archive_retention_days: 90        # Days to keep in archive.db (0=forever)
    auto_maintenance: true            # Run daily maintenance automatically
```

Environment variable overrides:
- `ROLLING_WINDOW_ENABLED`
- `ROLLING_WINDOW_HOT_DAYS`
- `ROLLING_WINDOW_ARCHIVE_DAYS`

### Migration Tool

New migration script to convert existing per-date databases:

```bash
# Preview migration (dry run)
python scripts/migrate_to_rolling_window.py --dry-run

# Run migration with backup
python scripts/migrate_to_rolling_window.py --backup

# Run migration and delete originals
python scripts/migrate_to_rolling_window.py --backup --delete-originals
```

## Schema Changes

- Added `crawl_date` column to `news_items` and `rss_items` tables
- Added `db_metadata` table for tracking database type and date ranges
- Added composite indexes for date-based queries

## Files Changed

| File | Changes |
|------|---------|
| `trendradar/storage/local.py` | Added `RollingWindowLocalBackend` class (~900 lines), `detect_new_titles_sql()`, `detect_new_rss_items_sql()` |
| `trendradar/storage/manager.py` | Added rolling_window backend support and maintenance methods |
| `trendradar/storage/schema.sql` | Added `crawl_date` column, indexes, `db_metadata` table |
| `trendradar/storage/rss_schema.sql` | Same schema changes for RSS |
| `trendradar/storage/base.py` | Added base method signatures |
| `trendradar/core/data.py` | Updated to use SQL optimization when available |
| `trendradar/core/loader.py` | Added rolling_window config loading |
| `trendradar/context.py` | Added maintenance integration in cleanup |
| `config/config.yaml` | Added rolling_window configuration section |
| `scripts/migrate_to_rolling_window.py` | New migration script |

## Performance Impact

| Metric | Before | After | Improvement |
|--------|--------|-------|-------------|
| DB files (30 days) | 60+ | 4 | ~15x fewer |
| detect_new_titles() memory | O(n) all items | O(k) new only | ~10x less |
| Remote sync complexity | O(n) files | O(2) files | Much simpler |

## Backward Compatibility

- Rolling window mode is **disabled by default**
- Per-date database mode remains fully supported
- Existing installations continue to work without changes
- Migration is optional and can be run when ready
