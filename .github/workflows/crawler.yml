name: Hot News Crawler

on:
  schedule:
    - cron: "0 * * * *" # æ¯å°æ—¶æ•´ç‚¹æ‰§è¡Œ
  workflow_dispatch:

permissions:
  contents: write

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required files
        run: |
          echo "ğŸ” æ£€æŸ¥é…ç½®æ–‡ä»¶..."
          if [ ! -f config/config.yaml ]; then
            echo "âŒ ç¼ºå°‘ config/config.yaml"
            exit 1
          fi
          if [ ! -f config/frequency_words.txt ]; then
            echo "âŒ ç¼ºå°‘ config/frequency_words.txt"
            exit 1
          fi
          echo "âœ… é…ç½®æ–‡ä»¶å®Œæ•´"

      - name: Run crawler
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          WEWORK_WEBHOOK_URL: ${{ secrets.WEWORK_WEBHOOK_URL }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO: ${{ secrets.EMAIL_TO }}
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ secrets.EMAIL_SMTP_PORT }}
          NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
          NTFY_SERVER_URL: ${{ secrets.NTFY_SERVER_URL }}
          NTFY_TOKEN: ${{ secrets.NTFY_TOKEN }}
          GITHUB_ACTIONS: true
        run: python main.py

      - name: Commit and push if changes (robust stash + rebase)
        run: |
          set -euo pipefail

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          echo "ğŸ” æ£€æµ‹å¹¶æš‚å­˜æ›´æ”¹..."
          git add -A || true

          # å¦‚æœæ²¡æœ‰ä»»ä½•å˜æ›´å°±é€€å‡º
          if git diff --quiet && git diff --staged --quiet; then
            echo "âœ¨ No changes detected. Exiting."
            exit 0
          fi

          # ç¡®ä¿ remote upstream å·²å­˜åœ¨ï¼ˆè‹¥å·²å­˜åœ¨åˆ™å¿½ç•¥é”™è¯¯ï¼‰
          git remote add upstream https://github.com/sansan0/TrendRadar.git 2>/dev/null || true
          git fetch upstream

          # æ ‡è®°æ˜¯å¦åšäº† stashï¼ˆä¾¿äºåç»­æ¢å¤åˆ¤æ–­ï¼‰
          STASHED=false

          # å¦‚æœå·¥ä½œåŒºæœ‰ä»»ä½•æ›´æ”¹ï¼ˆåŒ…æ‹¬æœªè·Ÿè¸ªæ–‡ä»¶ï¼‰ï¼Œä½¿ç”¨ stash -u æš‚å­˜
          if [ -n "$(git status --porcelain)" ]; then
            echo "ğŸ“¦ å·¥ä½œåŒºæœ‰æ”¹åŠ¨ï¼Œä½¿ç”¨ git stash push -u æš‚å­˜ï¼ˆåŒ…å« untrackedï¼‰"
            if git stash push -u -m "crawler_changes@$(date -u +%Y%m%dT%H%M%SZ)"; then
              STASHED=true
              echo "âœ… stash æˆåŠŸ"
            else
              echo "âš ï¸ stash å¤±è´¥ï¼Œç»§ç»­ä½†å¯èƒ½å¯¼è‡´ rebase æŠ¥é”™"
            fi
          else
            echo "âœ… å·¥ä½œåŒºå¹²å‡€ï¼Œæ— éœ€ stash"
          fi

          # å°è¯• rebase åˆ° upstream/masterï¼ˆä¼˜å…ˆä½¿ç”¨ rebase ä¿æŒå†å²æ•´æ´ï¼‰
          REBASE_OK=false
          if git rebase upstream/master; then
            REBASE_OK=true
            echo "âœ… rebase upstream/master æˆåŠŸ"
          else
            echo "âš ï¸ rebase å¤±è´¥ï¼Œå°è¯•å›æ»š rebase å¹¶ä½¿ç”¨ merge ä½œä¸ºåå¤‡ç­–ç•¥"
            git rebase --abort || true
            # å°è¯•ç”¨ merge ä½œä¸ºåå¤‡æ–¹æ¡ˆï¼ˆmerge ä¸ä¼šå› ä¸º index æ±¡æŸ“å¤±è´¥ï¼‰
            if git merge --no-edit upstream/master; then
              echo "âœ… merge upstream/master æˆåŠŸï¼ˆä½œä¸º rebase çš„åå¤‡ï¼‰"
              REBASE_OK=true
            else
              echo "âŒ merge ä¹Ÿå¤±è´¥äº†ï¼Œæ¥ä¸‹æ¥å°è¯•æ¢å¤ stash å¹¶ä¿ç•™æœ¬æ¬¡æ”¹åŠ¨ä»¥ä¾¿äººå·¥æ£€æŸ¥"
              git merge --abort || true
              REBASE_OK=false
            fi
          fi

          # æ¢å¤ stashï¼ˆå¦‚æœæœ‰åš stashï¼‰
          if [ "$STASHED" = "true" ]; then
            echo "ğŸ“¤ æ¢å¤ stashï¼ˆä¼˜å…ˆä½¿ç”¨ --index æ¢å¤æš‚å­˜çŠ¶æ€ï¼‰"
            # å°è¯• popï¼ˆæ¢å¤å¹¶ä» stash åˆ—è¡¨ä¸­ç§»é™¤ï¼‰ï¼›å¦‚æœå†²çªå¯¼è‡´å¤±è´¥ï¼Œå…ˆå°è¯• apply ä¿ç•™ stash
            if git stash pop --index; then
              echo "âœ… stash pop æˆåŠŸ"
            else
              echo "âš ï¸ stash pop å¤±è´¥ï¼Œå°è¯• git stash apply ä¿ç•™ stash ä»¥ä¾¿æ’æŸ¥"
              git stash apply --index || true
            fi
          fi

          # é‡æ–° add å¹¶æäº¤æœ€ç»ˆåˆå¹¶ç»“æœï¼ˆå³ä½¿ commit æ²¡æœ‰ä¸œè¥¿ä¹Ÿä¸æŠ¥é”™ï¼‰
          git add -A || true
          git commit -m "Auto update by GitHub Actions at $(TZ=Asia/Shanghai date)" || echo "â„¹ï¸ æ²¡æœ‰æ–°çš„æäº¤å†…å®¹æˆ– commit è¢«è·³è¿‡"

          # æ¨é€åˆ° forkï¼ˆä½¿ç”¨ --force-with-lease å®‰å…¨è¦†ç›–ï¼‰
          echo "ğŸ“¤ æ¨é€åˆ° origin masterï¼ˆä½¿ç”¨ --force-with-leaseï¼‰"
          if git push origin HEAD:master --force-with-lease; then
            echo "âœ… push æˆåŠŸ"
          else
            echo "âŒ push å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™æˆ– remote çŠ¶æ€ï¼ˆä½† workflow ä¸è¿”å›å¤±è´¥ï¼‰"
            # ä¸è®©æ•´ä¸ª workflow å› æ¨é€å¤±è´¥è€Œç›´æ¥å¤±è´¥ï¼Œæ–¹ä¾¿åç»­æ’æŸ¥æ—¥å¿—
            exit 0
          fi
